---
title: é€šç”¨æ¥å£å‰ç½®è¯·æ±‚æ–¹æ¡ˆ
date: 2020-12-29
comments: true
category: experience
tags:
 - ç»éªŒ
---

## å‰è¨€

åœ¨è¶…æ°è·Ÿæˆ‘æå‡ºæ¥å£å‰ç½®æŠ€æ”¹çš„æ—¶å€™ï¼Œæˆ‘æ˜¯ä¸¾åŒæ‰‹èµæˆçš„ï¼Œå› ä¸ºä¼˜ç‚¹æ˜¯å¯ä»¥é¢„æƒ³å¾—åˆ°çš„ã€‚

æ ¹æ®ä¹‹å‰çš„åŸ‹ç‚¹ç»Ÿè®¡æ•°æ®åˆ†æï¼Œ**ä»ç”¨æˆ·ç‚¹å‡»æ’ä»¶åˆ°h5å‘èµ·è¯·æ±‚çš„è¿™ä¸€æ®µè¿‡æ¸¡æ—¶é—´**ï¼Œå¤§çº¦åœ¨**200ï½600ms**å·¦å³ï¼Œè€Œæ¥å£å‰ç½®æŠ€æ”¹å°†è¿™æ®µæ—¶é—´å……åˆ†åˆ©ç”¨èµ·æ¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ’ä»¶é¦–å±æ‹¿åˆ°æ•°æ®çš„æ—¶é—´é¢„è®¡å¯ä»¥å‡å°‘200ï½600msï¼Œè¿™å¯¹é¦–å±æ—¶é—´ã€ç”¨æˆ·å¯äº¤äº’æ—¶é—´éƒ½æœ‰è¾ƒå¤§çš„æ”¹è¿›ã€‚

æˆ‘ä»¬å¯ä»¥å‡è®¾å‡ ä¸ªæ•°æ®ï¼š

* æ‹‰èµ·æ’ä»¶æ—¶é—´ï¼š500ms;
* æ¥å£è¯·æ±‚æ—¶é—´ï¼š800ms;

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŠ€æ”¹å‰ï¼Œä»ç‚¹å‡»æ’ä»¶åˆ°å¯äº¤äº’çš„æ—¶é—´å¤§è‡´ä¸ºï¼š

```js
æ‹‰èµ·æ’ä»¶æ—¶é—´ + æ¥å£è¯·æ±‚æ—¶é—´ = 13000ms
```

æŠ€æ”¹åçš„æ—¶é—´ä¸ºï¼š

```js
æ‹‰èµ·æ’ä»¶æ—¶é—´ + (æ¥å£è¯·æ±‚æ—¶é—´ - æ‹‰èµ·æ’ä»¶æ—¶é—´) = 800ms
```

![ä¸nativeé€šä¿¡å›¾]()

## æ€è€ƒğŸ¤”

ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæŠ€æ”¹å¿…é¡»æ”¯æŒï¼Œä½†æ˜¯ç¼ºç‚¹å‘¢ï¼Ÿåˆ†æä¸‹æ¥æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

* æ–°å¢APIï¼Œéœ€è¦è€ƒè™‘å…¼å®¹é—®é¢˜ï¼›
* å‰ç½®çš„æ¥å£æœ‰å¤šä¸ªï¼Œæœ‰äº›ä¸šåŠ¡æ˜¯å¹¶è¡Œçš„ï¼Œè€Œæœ‰äº›æ˜¯ä¸²è¡Œçš„ï¼›
* å¯¹ä¸šåŠ¡æœ‰è¾ƒå¤§çš„ä¾µå…¥æ€§ï¼Œéœ€è¦ä¿®æ”¹ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ‰ä¸€å®šçš„é£é™©ï¼›
* å¦‚æœéœ€è¦æ–°å¢ã€ä¿®æ”¹å‰ç½®æ¥å£ä¸ä»…è¦æ”¹cmsé…ç½®ï¼Œè¿˜è¦å‘ç‰ˆæœ¬æ”¹ä¸šåŠ¡ï¼›

ç»¼ä¸Šè€ƒè™‘ï¼Œæ˜¯æœ‰ä¸€å®šçš„æ¥å…¥æˆæœ¬çš„ï¼Œå¦‚æœæœ‰ä¸€å¥—ç®€å•æ˜“ç”¨æ— ä¾µå…¥çš„é€šç”¨æ–¹æ¡ˆï¼Œå°±å¯ä»¥å°†æˆåŠŸç»éªŒå¿«é€Ÿç§»æ¤åˆ°å…¶å®ƒä¸šåŠ¡ï¼Œå²‚ä¸ç¾å“‰ï¼ŸğŸ˜„

## è®¾è®¡

é€šç”¨æ–¹æ¡ˆæœ‰ä»¥ä¸‹å‡ ä¸ªç›®æ ‡ï¼š

* åšå¥½å…¼å®¹å¤„ç†ï¼›
* æ¥å…¥è¿‡ç¨‹ä¸å…³å¿ƒã€ä¸ä¾µå…¥ä¸šåŠ¡ï¼›
* æœ‰åŸ‹ç‚¹ï¼Œå¯ç»Ÿè®¡ï¼›
* ä»»æ„æ–°å¢ã€ä¿®æ”¹å‰ç½®æ¥å£ï¼Œåªéœ€è¦ä¿®æ”¹cmsé…ç½®ï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼›

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•è®¾è®¡ä¸€ä¸‹å®ç°æ–¹æ¡ˆï¼š

![prefetchå±‚]()

## å®ç°ç»†èŠ‚ä¸€è§ˆ

æ¥å£å‰ç½®ç›®å‰åœ¨newfasè¯•ç‚¹ï¼Œç”±äºnewfasä½¿ç”¨çš„æ˜¯commonCaikuçš„axioså°è£…ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œç»Ÿä¸€æ¥å…¥

```js
// axios.js
import prefetchInstance from './prefetch';

const axiosHandle = (...) => {
    // prefetchåˆå§‹åŒ–
    if (!prefetchInstance.initialized) {
        prefetchInstance.init();
    }

    // è·å–å¯¹åº”urlæ•°æ®
    const prefetchedUrlData = await prefetchInstance.getUrlData(originReqUrl);
    
    // è·å–åˆ°æ•°æ®åˆ™ç›´æ¥è¿”å›
    if (prefetchedUrlData) {
        // å–å®Œæ•°æ®åæ¸…ç©º
        prefetchInstance.clearUrlData(originReqUrl);
        // å…³é”®åŸ‹ç‚¹ï¼Œå‰ç½®æ¥å£çœŸå®ä½¿ç”¨æ—¶é—´
        prefetchInstance.log('api-prefetch-spending-time-per-url',{...}ï¼‰;
        
        return resHandle(...);
    } else {
        // åŸaxiosé€»è¾‘
        return instance({...}).then((res) => resHandle(...))
    }
}


// pretch.js
class Prefetch {
    constructor() {
        // cmsé…ç½®çš„é¢„è¯·æ±‚æ¥å£
        this.supportUrls = null;
        // nativeé¢„è¯·æ±‚çš„æ•°æ®
        this.prefetchData = null;
        // æ˜¯å¦å·²ä»nativeè·å¾—æ•°æ®
        this.fetched = false;
        // å½“å‰appæ˜¯å¦æ”¯æŒé¢„è¯·æ±‚
        this.isPrefetchSupport = false;
        // é¢„è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—
        this.waitingQuene = [];
        // nativeé¢„è¯·æ±‚èŠ±è´¹æ—¶é—´
        this.fetchSpendingTime = 0;
        // nativeé€šä¿¡è¶…æ—¶è®¾ç½®
        this.maxTimeOut = 5000;
        // é€šä¿¡è®¡æ—¶å™¨
        this.timer = null;
        // åˆå§‹åŒ–çŠ¶æ€
        this.initialized = false;
    }

    init() {
        this.initialized = true;
        this.isPrefetchSupport = this.ifPrefetchSupport();

        if (this.isPrefetchSupport) {
            this.getSupportUrls();
            this.getPluginPrefixAPIData();
        }
        // ...
    }

    // åˆ¤æ–­å½“å‰appæ˜¯å¦æ”¯æŒé¢„è¯·æ±‚
    ifPrefetchSupport() {}

    // åŒæ­¥æ¥å£ä»nativeè·å–cmsé…ç½®é¢„è¯·æ±‚æ¥å£
    getSupportUrls() {}

    // åˆ¤æ–­å½“å‰urlæ˜¯å¦åœ¨cmsé…ç½®
    ifUrlSupport() {}

    // ä»nativeè·å–é¢„è¯·æ±‚æ•°æ®
    getPluginPrefixAPIData() {}

    // ä¸šåŠ¡è¯·æ±‚é˜Ÿåˆ—
    resolveWaitingQuene() {}

    // è·å–å¯¹åº”urlçš„é¢„è¯·æ±‚æ•°æ®
    getUrlData(url) {}

    // é¢„è¯·æ±‚æ•°æ®åªä½¿ç”¨ä¸€æ¬¡åå³æ¸…ç©º
    clearUrlData(url) {}

    // å¯¹å…³é”®èŠ‚ç‚¹è¿›è¡ŒåŸ‹ç‚¹
    log() {}
}
```
